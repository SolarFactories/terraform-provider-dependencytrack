name: CDKTF Bindings

on:
  workflow_call:
  workflow_dispatch:
  push:
    branches:
      - cdktf-bindings
      - cdktf-bindings-refactor

permissions:
  contents: write
  packages: write

jobs:
  gen-typescript:
    uses: ./.github/workflows/cdktf-gen-typescript.yml
    with:
      typescript-artifact-name: "cdktf-typescript"

  gen-javascript:
    needs:
      - gen-typescript
    uses: ./.github/workflows/cdktf-gen-javascript.yml
    with:
      typescript-artifact-name: "cdktf-typescript"
      javascript-artifact-name: "cdktf-javascript"

  rel-typescript-github:
    needs:
      - gen-javascript
    uses: ./.github/workflows/cdktf-rel-typescript-github.yml
    with:
      javascript-artifact-name: "cdktf-javascript"

  gen-python:
    # Works locally, but fails without helpful errors in pipeline, so disable for now.
    # If required, may still run `cdktf get` locally within a CDKTF project.
    if: false
    uses: ./.github/workflows/cdktf-gen-python.yml
    with:
      python-artifact-name: "cdktf-python"

  rel-typescript-github:
    runs-on: ubuntu-latest
    needs: gen-typescript
    steps:
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: cdktf-typescript
      - name: Extract package
        run: |
          FILENAME="$(find . -type f -name 'solarfactories-cdktf-provider-dependencytrack-*.tgz')"
          echo "${FILENAME}"
          tar -xf "${FILENAME}"
      - uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v4.3.0
        with:
          registry-url: "https://npm.pkg.github.com"
          scope: "@solarfactories"
      - name: Publish
        run: npm publish
        working-directory: package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
